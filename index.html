<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Fit Assistant AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.com/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1e1e1e; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        h2 { margin: 10px 0; font-size: 1.2rem; text-align: center; }
        .container { position: relative; width: 100%; max-width: 640px; height: 55vh; background: black; border-radius: 10px; overflow: hidden; }
        video { display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* å„€è¡¨æ¿æ¨£å¼ */
        .dashboard { width: 100%; max-width: 640px; background: #333; padding: 10px; box-sizing: border-box; border-top: 2px solid #555; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; }
        .metric { text-align: center; flex: 1; min-width: 45%; margin-bottom: 10px;} /* è®“æ¯å€‹ metric ä½”ä¸€åŠå¯¬ */
        .metric-value { font-size: 1.8rem; font-weight: bold; color: #00d4ff; }
        .metric-label { font-size: 0.8rem; color: #aaa; }
        #max-knee-angle-val { color: #00ff88; }
        #max-torso-angle-val { color: #ffeb3b; } /* è»€å¹¹è§’åº¦ç”¨ä¸åŒé¡è‰² */
        
        /* é‡ç½®æŒ‰éˆ• */
        .reset-btn { background-color: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 5px; width: 90%; }
        .reset-btn:active { background-color: #ff6b81; }

        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; z-index: 100; text-align: center; }

        .advice-box {
            width: 100%;
            max-width: 640px;
            background: #444;
            padding: 10px 15px;
            box-sizing: border-box;
            margin-top: 5px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #ccc;
            min-height: 80px;
        }
        .advice-title { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .advice-text { color: #f0f0f0; }
    </style>
</head>
<body>

    <h2>ğŸš´ Bike Fit AI (Right Side)</h2>

    <div class="container">
        <div class="loading" id="loading">æ¨¡å‹è¼‰å…¥ä¸­...<br>è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™</div>
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="dashboard">
        <div class="metric">
            <div class="metric-value" id="current-knee-angle">--</div>
            <div class="metric-label">å³æ™‚è†è“‹è§’</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="max-knee-angle-val">--</div>
            <div class="metric-label">ä¸‹æ­»é» (æœ€å¤§)</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="current-torso-angle">--</div>
            <div class="metric-label">å³æ™‚è»€å¹¹è§’</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="max-torso-angle-val">--</div>
            <div class="metric-label">æœ€ä½³è»€å¹¹è§’</div>
        </div>
        <button class="reset-btn" onclick="resetData()">ğŸ”„ é‡ç½®æ•¸æ“š</button>
    </div>

    <div class="advice-box">
        <div class="advice-title">èª¿æ•´å»ºè­°:</div>
        <div class="advice-text" id="advice-text">è«‹é–‹å§‹è¸©è¸ä»¥ç²å–åˆ†ææ•¸æ“šã€‚</div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingMsg = document.getElementById('loading');
        
        // æ•¸æ“šé¡¯ç¤º DOM
        const currentKneeAngleDisplay = document.getElementById('current-knee-angle');
        const maxKneeAngleDisplay = document.getElementById('max-knee-angle-val');
        const currentTorsoAngleDisplay = document.getElementById('current-torso-angle');
        const maxTorsoAngleDisplay = document.getElementById('max-torso-angle-val');
        const adviceText = document.getElementById('advice-text');

        let maxKneeAngle = 0; // ç´€éŒ„æœ€å¤§è†è“‹å»¶ä¼¸è§’åº¦ (ä¸‹æ­»é»)
        let maxTorsoAngle = 0; // ç´€éŒ„æœ€ä½³è»€å¹¹è§’åº¦ (é€šå¸¸æ˜¯è¸©è¸æ™‚æœ€ç©©å®šçš„è§’åº¦)

        function resetData() {
            maxKneeAngle = 0;
            maxTorsoAngle = 0;
            currentKneeAngleDisplay.innerText = "--";
            maxKneeAngleDisplay.innerText = "--";
            currentTorsoAngleDisplay.innerText = "--";
            maxTorsoAngleDisplay.innerText = "--";
            adviceText.innerText = "è«‹é–‹å§‹è¸©è¸ä»¥ç²å–åˆ†ææ•¸æ“šã€‚";
        }

        // è¨ˆç®—ä¸‰é»è§’åº¦çš„æ•¸å­¸å‡½å¼ (é ‚é» B)
        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        // è¨ˆç®—è»€å¹¹è§’åº¦çš„ç‰¹æ®Šå‡½å¼ (é«–éƒ¨åˆ°è‚©è†€èˆ‡æ°´å¹³ç·šçš„å¤¾è§’)
        function calculateTorsoAngle(hip, shoulder) {
            // å»ºç«‹ä¸€å€‹å‡è¨­çš„æ°´å¹³é» (åœ¨é«–éƒ¨å‰æ–¹)
            const horizontalPoint = {x: hip.x - 0.1, y: hip.y}; // å‡è¨­æ°´å¹³é»åœ¨é«–éƒ¨å·¦å´ä¸€é»é»
            return calculateAngle(horizontalPoint, hip, shoulder);
        }

        // æ ¹æ“šè§’åº¦çµ¦å‡ºå»ºè­°
        function getFitAdvice(kneeAngle, torsoAngle) {
            let advice = [];

            // è†è“‹è§’åº¦å»ºè­° (ä¸€èˆ¬å…¬è·¯è»Šä¸‹æ­»é»å»ºè­° 140-150 åº¦)
            if (kneeAngle === 0) { // åˆå§‹ç‹€æ…‹
                advice.push("è«‹ä¿æŒç©©å®šè¸©è¸ï¼Œä»¥ä¾¿æ”¶é›†æ•¸æ“šã€‚");
            } else if (kneeAngle > 155) {
                advice.push("è†è“‹å»¶ä¼¸éåº¦ (è§’åº¦ > 155Â°)ï¼Œåº§å¢Šå¯èƒ½å¤ªé«˜ï¼Œæˆ–æ›²æŸ„å¤ªé•·ã€‚");
            } else if (kneeAngle < 135 && kneeAngle > 0) { // æ’é™¤åˆå§‹0åº¦
                advice.push("è†è“‹å½æ›²éå¤š (è§’åº¦ < 135Â°)ï¼Œåº§å¢Šå¯èƒ½å¤ªä½ã€‚");
            } else if (kneeAngle >= 135 && kneeAngle <= 155) {
                advice.push("è†è“‹å»¶ä¼¸è§’åº¦è‰¯å¥½ (135Â°-155Â°)ã€‚");
            }

            // è»€å¹¹è§’åº¦å»ºè­° (ä¸€èˆ¬å…¬è·¯è»Šå»ºè­° 40-55 åº¦ä¹‹é–“ï¼Œé€™è£¡çš„æ¸¬é‡æ˜¯ã€ŒèƒŒéƒ¨èˆ‡æ°´å¹³ç·šçš„å¤¾è§’ã€)
            // é€™å€‹è§’åº¦å®šç¾©æ–¹å¼æœƒå½±éŸ¿å»ºè­°å€¼ï¼Œç›®å‰æ˜¯è‚©-é«–-æ°´å¹³ï¼Œç´„40-55åº¦ç‚ºç«¶è³½ï¼Œ55-65ç‚ºèˆ’é©
            if (torsoAngle > 65) {
                advice.push("è»€å¹¹è§’åº¦è¼ƒç›´ (> 65Â°)ï¼Œå¯èƒ½éæ–¼ä¼‘é–’æˆ–æ¡æŠŠä½ç½®å¤ªé«˜ï¼Œå¯ä»¥è€ƒæ…®é™ä½æŠŠæ‰‹æˆ–å¢é•·é¾é ­ã€‚");
            } else if (torsoAngle < 40 && torsoAngle > 0) {
                advice.push("è»€å¹¹è§’åº¦éä½ (< 40Â°)ï¼Œå¯èƒ½éæ–¼æ¿€é€²ï¼Œèº«é«”è² æ“”è¼ƒå¤§ï¼Œå¯èƒ½éœ€è¦æé«˜æŠŠæ‰‹æˆ–ç¸®çŸ­é¾é ­ã€‚");
            } else if (torsoAngle >= 40 && torsoAngle <= 65) {
                advice.push("è»€å¹¹è§’åº¦åœ¨èˆ’é©ç¯„åœ (40Â°-65Â°)ã€‚");
            }

            if (advice.length === 0) {
                return "æ­£åœ¨åˆ†æä¸­...";
            } else {
                return advice.join("<br>");
            }
        }


        // MediaPipe çµæœè™•ç†
        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1});

                // å³å´é—œéµé»ï¼š12(å³è‚©), 24(å³é«–), 26(å³è†), 28(å³è¸)
                const shoulder = results.poseLandmarks[12];
                const hip = results.poseLandmarks[24];
                const knee = results.poseLandmarks[26];
                const ankle = results.poseLandmarks[28];

                // ä¿¡å¿ƒåº¦éæ¿¾
                const minVisibility = 0.6; // èª¿æ•´ä¿¡å¿ƒåº¦é–€æª»
                if (shoulder.visibility > minVisibility && hip.visibility > minVisibility && 
                    knee.visibility > minVisibility && ankle.visibility > minVisibility) {
                    
                    // è¨ˆç®—è†è“‹è§’åº¦
                    let currentKneeAngle = calculateAngle(hip, knee, ankle);
                    currentKneeAngleDisplay.innerText = Math.round(currentKneeAngle) + "Â°";

                    // æ›´æ–°æœ€å¤§è†è“‹è§’åº¦ (åªåœ¨åˆç†çš„ç¯„åœå…§æ›´æ–°ï¼Œé¿å…åˆæœŸèª¤åˆ¤)
                    if (currentKneeAngle > maxKneeAngle && currentKneeAngle < 175 && currentKneeAngle > 100) {
                        maxKneeAngle = currentKneeAngle;
                        maxKneeAngleDisplay.innerText = Math.round(maxKneeAngle) + "Â°";
                    }

                    // è¨ˆç®—è»€å¹¹è§’åº¦ (è‚©-é«–-æ°´å¹³ç·š)
                    let currentTorsoAngle = calculateTorsoAngle(hip, shoulder);
                    currentTorsoAngleDisplay.innerText = Math.round(currentTorsoAngle) + "Â°";

                    // æ›´æ–°æœ€å¤§è»€å¹¹è§’åº¦ (é€™è£¡çš„ "max" ä»£è¡¨è§€å¯Ÿåˆ°æœ€å¹³ç©©çš„å¹³å‡å€¼ï¼Œè€ŒéçœŸçš„æœ€å¤§å€¼)
                    // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡ä¸€æ¨£ç”¨ maxï¼Œä½†å¯¦éš› fitting æœƒæ‰¾ç©©å®šå€é–“
                    if (currentTorsoAngle > maxTorsoAngle && currentTorsoAngle < 120 && currentTorsoAngle > 10) {
                        maxTorsoAngle = currentTorsoAngle;
                        maxTorsoAngleDisplay.innerText = Math.round(maxTorsoAngle) + "Â°";
                    }
                    
                    // ç¹ªè£½è†è“‹è§’åº¦æ¨™ç±¤
                    const kx = knee.x * canvasElement.width;
                    const ky = knee.y * canvasElement.height;
                    canvasCtx.font = "bold 24px Arial";
                    canvasCtx.fillStyle = "#00ff88";
                    canvasCtx.fillText(Math.round(currentKneeAngle) + "Â°", kx + 15, ky - 20);

                    // ç¹ªè£½è»€å¹¹è§’åº¦æ¨™ç±¤ (åœ¨é«–éƒ¨ä¸Šæ–¹)
                    const hx = hip.x * canvasElement.width;
                    const hy = hip.y * canvasElement.height;
                    canvasCtx.fillStyle = "#ffeb3b";
                    canvasCtx.fillText(Math.round(currentTorsoAngle) + "Â°", hx + 15, hy - 20);

                    // æ›´æ–°å»ºè­°
                    adviceText.innerHTML = getFitAdvice(maxKneeAngle, maxTorsoAngle);

                    // å¼·èª¿é—œéµé»
                    [shoulder, hip, knee, ankle].forEach(pt => {
                        canvasCtx.beginPath();
                        canvasCtx.arc(pt.x * canvasElement.width, pt.y * canvasElement.height, 5, 0, 2 * Math.PI);
                        canvasCtx.fillStyle = "red";
                        canvasCtx.fill();
                    });

                } else {
                     adviceText.innerHTML = "åµæ¸¬ä¸­...è«‹ç¢ºä¿èº«é«”é—œéµéƒ¨ä½æ¸…æ™°å¯è¦‹ã€‚";
                }
            } else {
                adviceText.innerHTML = "åµæ¸¬ä¸­...è«‹ç¢ºä¿èº«é«”é—œéµéƒ¨ä½æ¸…æ™°å¯è¦‹ã€‚";
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480, facingMode: "environment"
        });
        camera.start();
    </script>
</body>
</html>
