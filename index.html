<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Fit Assistant AI (Debug Ver.)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1e1e1e; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h2 { margin: 10px 0; font-size: 1.2rem; text-align: center; }
        
        .container { position: relative; width: 100%; max-width: 640px; height: 50vh; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; } /* éš±è—åŸå§‹å½±åƒï¼Œåªé¡¯ç¤º canvas */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* æ§åˆ¶å€ */
        .controls { width: 90%; max-width: 640px; margin-bottom: 10px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; font-weight: bold; }
        #btn-start { background-color: #00d4ff; color: #000; }
        #btn-reset { background-color: #ff4757; color: white; }
        
        /* æ•¸æ“šå„€è¡¨æ¿ */
        .dashboard { width: 100%; max-width: 640px; background: #333; padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: space-around; }
        .metric { text-align: center; width: 45%; margin: 5px 0; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .metric-label { font-size: 0.8rem; color: #aaa; }
        
        /* éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ */
        #error-log { color: #ff4757; font-size: 0.9rem; padding: 10px; text-align: center; width: 90%; word-break: break-all; }
        
        /* å»ºè­°å€ */
        .advice { width: 90%; max-width: 640px; margin-top: 10px; background: #444; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #ddd; }
    </style>
</head>
<body>

    <h2>ğŸš´ Bike Fit AI V2</h2>

    <div class="controls">
        <button id="btn-start" onclick="startCamera()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
        <button id="btn-reset" onclick="resetData()">ğŸ”„ é‡ç½®æ•¸æ“š</button>
    </div>
    
    <div id="error-log"></div>

    <div class="container">
        <video id="input_video" playsinline muted></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="dashboard">
        <div class="metric">
            <div class="metric-label">è†è“‹è§’åº¦</div>
            <div class="metric-value" id="val-knee">--</div>
        </div>
        <div class="metric">
            <div class="metric-label">æœ€å¤§å»¶ä¼¸ (ä¸‹æ­»é»)</div>
            <div class="metric-value" style="color: #00ff88;" id="val-max-knee">--</div>
        </div>
        <div class="metric">
            <div class="metric-label">è»€å¹¹è§’åº¦</div>
            <div class="metric-value" id="val-torso">--</div>
        </div>
        <div class="metric">
            <div class="metric-label">å¹³å‡è»€å¹¹è§’</div>
            <div class="metric-value" style="color: #ffeb3b;" id="val-avg-torso">--</div>
        </div>
    </div>

    <div class="advice" id="advice-text">
        é»æ“Šä¸Šæ–¹ã€Œé–‹å•Ÿç›¸æ©Ÿã€æŒ‰éˆ•é–‹å§‹ã€‚è«‹çµ¦äºˆç›¸æ©Ÿæ¬Šé™ã€‚
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const errorLog = document.getElementById('error-log');
        const btnStart = document.getElementById('btn-start');

        let pose;
        let cameraRunning = false;
        let animationId;

        // æ•¸æ“šè®Šæ•¸
        let maxKneeAngle = 0;
        let torsoAngleSum = 0;
        let torsoCount = 0;

        function logError(msg) {
            errorLog.innerText = "âš ï¸ " + msg;
            console.error(msg);
        }

        function resetData() {
            maxKneeAngle = 0;
            torsoAngleSum = 0;
            torsoCount = 0;
            document.getElementById('val-max-knee').innerText = "--";
            document.getElementById('val-avg-torso').innerText = "--";
            document.getElementById('advice-text').innerText = "æ•¸æ“šå·²é‡ç½®";
        }

        // æ ¸å¿ƒé‹ç®—è¿´åœˆ
        async function predict() {
            if (!cameraRunning) return;

            // ç¢ºä¿å½±ç‰‡æœ‰è¼‰å…¥
            if (videoElement.readyState === 4) {
                // è¨­å®š Canvas å¤§å°
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // é€å…¥ MediaPipe è™•ç†
                await pose.send({image: videoElement});
            }
            
            // ç¹¼çºŒä¸‹ä¸€å¹€
            animationId = requestAnimationFrame(predict);
        }

        async function startCamera() {
            if (cameraRunning) return;
            errorLog.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...";
            
            try {
                // åˆå§‹åŒ– MediaPipe
                if (!pose) {
                    pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
                    pose.setOptions({
                        modelComplexity: 1,
                        smoothLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    pose.onResults(onResults);
                }

                // åŸç”Ÿ getUserMedia å‘¼å« (æ¯” Camera Utils æ›´ç©©å®š)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });

                videoElement.srcObject = stream;
                
                // ç­‰å¾…å½±ç‰‡è¼‰å…¥
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    cameraRunning = true;
                    btnStart.innerText = "ç›¸æ©Ÿé‹ä½œä¸­";
                    btnStart.disabled = true;
                    errorLog.innerText = "";
                    predict(); // é–‹å§‹è¿´åœˆ
                };

            } catch (err) {
                let msg = "ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err.name;
                if (err.name === 'NotAllowedError') msg = "æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ï¼Œè«‹é‡æ•´ç¶²é ä¸¦å…è¨±ã€‚";
                if (err.name === 'NotFoundError') msg = "æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®ã€‚";
                logError(msg + " (" + err.message + ")");
            }
        }

        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                
                // å–å¾—é—œéµé» (å³å´)
                const p = results.poseLandmarks;
                const rShoulder = p[12], rHip = p[24], rKnee = p[26], rAnkle = p[28];

                // æª¢æŸ¥æ˜¯å¦éƒ½åœ¨ç•«é¢ä¸­
                if (rShoulder.visibility > 0.5 && rHip.visibility > 0.5 && rKnee.visibility > 0.5 && rAnkle.visibility > 0.5) {
                    
                    // 1. è†è“‹è§’åº¦
                    let kAngle = calculateAngle(rHip, rKnee, rAnkle);
                    document.getElementById('val-knee').innerText = Math.round(kAngle) + "Â°";

                    // æ›´æ–°æœ€å¤§è†è“‹è§’ (ç°¡å–®æ¿¾æ³¢)
                    if (kAngle > maxKneeAngle && kAngle < 175 && kAngle > 100) {
                        maxKneeAngle = kAngle;
                        document.getElementById('val-max-knee').innerText = Math.round(maxKneeAngle) + "Â°";
                        updateAdvice();
                    }

                    // 2. è»€å¹¹è§’åº¦ (è‚©-é«–-æ°´å¹³)
                    // è™›æ“¬æ°´å¹³é»
                    let tAngle = calculateAngle({x: rHip.x - 0.5, y: rHip.y}, rHip, rShoulder);
                    document.getElementById('val-torso').innerText = Math.round(tAngle) + "Â°";

                    // è¨ˆç®—å¹³å‡è»€å¹¹è§’ (ç°¡å–®å¹³å‡)
                    if (tAngle > 10 && tAngle < 100) {
                        torsoAngleSum += tAngle;
                        torsoCount++;
                        let avgTorso = torsoAngleSum / torsoCount;
                        document.getElementById('val-avg-torso').innerText = Math.round(avgTorso) + "Â°";
                    }

                    // ç¹ªè£½æ–‡å­—
                    canvasCtx.font = "24px Arial";
                    canvasCtx.fillStyle = "#00ff88";
                    canvasCtx.fillText(Math.round(kAngle) + "Â°", rKnee.x * canvasElement.width + 10, rKnee.y * canvasElement.height);
                    
                    canvasCtx.fillStyle = "#ffeb3b";
                    canvasCtx.fillText(Math.round(tAngle) + "Â°", rHip.x * canvasElement.width + 10, rHip.y * canvasElement.height);
                }
            }
            canvasCtx.restore();
        }

        function updateAdvice() {
            let msg = "";
            if (maxKneeAngle > 155) msg += "âš ï¸ åº§å¢Šå¯èƒ½å¤ªé«˜ (è†è“‹ > 155Â°)<br>";
            else if (maxKneeAngle < 135) msg += "âš ï¸ åº§å¢Šå¯èƒ½å¤ªä½ (è†è“‹ < 135Â°)<br>";
            else msg += "âœ… è†è“‹ä¼¸å±•è§’åº¦è‰¯å¥½ (135-155Â°)<br>";

            document.getElementById('advice-text').innerHTML = msg;
        }

    </script>
</body>
</html>
