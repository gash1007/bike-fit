<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Fit Assistant AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1e1e1e; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        h2 { margin: 10px 0; font-size: 1.2rem; text-align: center; }
        .container { position: relative; width: 100%; max-width: 640px; height: 65vh; background: black; border-radius: 10px; overflow: hidden; }
        video { display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* å„€è¡¨æ¿æ¨£å¼ */
        .dashboard { width: 100%; max-width: 640px; background: #333; padding: 10px; box-sizing: border-box; border-top: 2px solid #555; display: flex; justify-content: space-around; align-items: center; height: 25vh; flex-wrap: wrap; }
        .metric { text-align: center; flex: 1; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #00d4ff; }
        .metric-label { font-size: 0.9rem; color: #aaa; }
        #max-angle-val { color: #00ff88; }
        
        /* é‡ç½®æŒ‰éˆ• */
        .reset-btn { background-color: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 5px; width: 90%; }
        .reset-btn:active { background-color: #ff6b81; }

        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; z-index: 100; text-align: center; }
    </style>
</head>
<body>

    <h2>ğŸš´ Bike Fit AI (Right Side)</h2>

    <div class="container">
        <div class="loading" id="loading">æ¨¡å‹è¼‰å…¥ä¸­...<br>è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™</div>
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="dashboard">
        <div class="metric">
            <div class="metric-value" id="current-angle">--</div>
            <div class="metric-label">å³æ™‚è§’åº¦</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="max-angle-val">--</div>
            <div class="metric-label">ä¸‹æ­»é» (æœ€å¤§)</div>
        </div>
        <button class="reset-btn" onclick="resetMax()">ğŸ”„ é‡ç½®æ•¸æ“š</button>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingMsg = document.getElementById('loading');
        const currentAngleDisplay = document.getElementById('current-angle');
        const maxAngleDisplay = document.getElementById('max-angle-val');

        let maxAngle = 0;

        function resetMax() {
            maxAngle = 0;
            maxAngleDisplay.innerText = "--";
            currentAngleDisplay.innerText = "--";
        }

        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                // ç¹ªè£½éª¨æ¶
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                
                // å³å´é—œéµé»ï¼š24(é«–), 26(è†), 28(è¸)
                const hip = results.poseLandmarks[24];
                const knee = results.poseLandmarks[26];
                const ankle = results.poseLandmarks[28];

                // ä¿¡å¿ƒåº¦éæ¿¾
                if (hip.visibility > 0.6 && knee.visibility > 0.6 && ankle.visibility > 0.6) {
                    let angle = calculateAngle(hip, knee, ankle);
                    
                    // é¡¯ç¤ºå³æ™‚è§’åº¦
                    currentAngleDisplay.innerText = Math.round(angle) + "Â°";

                    // æ›´æ–°æœ€å¤§è§’åº¦ (ç°¡å–®éæ¿¾ï¼šè§’åº¦éœ€å¤§æ–¼100ä¸”å°æ–¼175æ‰è¦–ç‚ºæœ‰æ•ˆé¨ä¹˜å‹•ä½œ)
                    if (angle > maxAngle && angle < 175 && angle > 100) {
                        maxAngle = angle;
                        maxAngleDisplay.innerText = Math.round(maxAngle) + "Â°";
                    }

                    // ç¹ªè£½æ¨™ç±¤
                    const kx = knee.x * canvasElement.width;
                    const ky = knee.y * canvasElement.height;
                    canvasCtx.font = "bold 30px Arial";
                    canvasCtx.fillStyle = "#00ff88";
                    canvasCtx.fillText(Math.round(angle) + "Â°", kx + 20, ky);
                    
                    // å¼·èª¿é—œéµé»
                    [hip, knee, ankle].forEach(pt => {
                        canvasCtx.beginPath();
                        canvasCtx.arc(pt.x * canvasElement.width, pt.y * canvasElement.height, 5, 0, 2 * Math.PI);
                        canvasCtx.fillStyle = "red";
                        canvasCtx.fill();
                    });
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480, facingMode: "environment"
        });
        camera.start();
    </script>
</body>
</html>